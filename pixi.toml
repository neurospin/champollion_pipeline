[workspace]
name = "champollion"
version = "0.1.0"
description = "Champollion pipeline with cortical_tiles, champollion_utils, and testing infrastructure"
channels = ["https://brainvisa.info/neuro-forge", "pytorch", "nvidia", "conda-forge"]
platforms = ["linux-64"]

[dependencies]
python = ">=3.8"
soma-env = ">=0.0"
libjpeg-turbo = { channel = "conda-forge", version = ">=3.0" }
anatomist = ">=0.0.29"
morphologist = ">=0.0.29"
pip = ">=25.3,<26"
setuptools = ">=65.0,<81"
flake8 = ">=7.3.0,<8"
pytest = ">=7.0"
pytest-cov = ">=4.0"
pytest-mock = ">=3.10"

[pypi-dependencies]
dracopy = ">=1.4.2"
huggingface-hub = ">=0.20.0"
transformers = ">=4.36.0"
datasets = ">=2.16.0"

[tasks]
# Initialize submodules
init-submodules = "git submodule update --init --recursive"

# Install cortical_tiles in editable mode
install-cortical-tiles = "cd external/cortical_tiles && SKLEARN_ALLOW_DEPRECATED_SKLEARN_PACKAGE_INSTALL=True pip install -e ."

# Install Champollion v1 in editable mode
install-champollion = "cd external/champollion_V1 && pip install -e ."

# Install champollion_utils in editable mode
install-utils = """
  cd .. && git clone https://github.com/neurospin/champollion_utils.git 2>/dev/null || echo 'champollion_utils already exists' && \
  cd champollion_utils && pip install -e . && cd ..
"""

# Create data directory
setup-data = "mkdir -p ../data"

# Global task to install everything
install-all = { depends-on = ["init-submodules", "install-cortical-tiles", "install-champollion", "install-utils", "setup-data"] }

# Pull latest changes for the main champollion_pipeline repo
update-pipeline = "git pull"

# Update git submodules to latest commits on their tracked branches
update-submodules = """
  git submodule update --remote --merge external/champollion_V1 && \
  git submodule update --remote --merge external/cortical_tiles && \
  cd external/cortical_tiles && cd ../..
"""

# Update champollion_utils (pull latest from main)
update-utils = """
  cd ../champollion_utils && git pull origin main 2>/dev/null || echo 'champollion_utils not found or pull failed'
"""

# Reinstall Python packages to pick up dependency changes
reinstall-packages = """
  cd external/cortical_tiles && SKLEARN_ALLOW_DEPRECATED_SKLEARN_PACKAGE_INSTALL=True pip install -e . && \
  cd ../champollion_V1 && pip install -e . && \
  cd ../../.. && cd champollion_utils && pip install -e . && cd ..
"""

# Full update: pull repos and reinstall packages
update = { depends-on = ["update-pipeline", "update-submodules", "update-utils", "reinstall-packages"] }

# Uninstall task: removes cloned repos, installed packages, and data
uninstall = """
  git submodule deinit -f external/champollion_V1 && \
  git submodule deinit -f external/cortical_tiles && \
  rm -rf external/champollion_V1 external/cortical_tiles && \
  rm -rf ../champollion_utils && \
  pip uninstall dracopy cortical_tiles champollion_V1 champollion_utils -y && \
  rm -rf data && \
  echo "Uninstallation complete."
"""

# Uninstall everything, including Pixi-managed dependencies
uninstall-all = """
  rm -rf .pixi pixi.lock && \
  rm -rf external/champollion_V1 external/cortical_tiles && \
  rm -rf ../champollion_utils && \
  rm -rf data && \
  echo "Uninstallation of Pixi-managed dependencies complete."
"""

# Testing tasks (run from champollion_pipeline directory)
test = "cd champollion_pipeline && pytest tests/ -v"
test-unit = "cd champollion_pipeline && pytest tests/ -v -m unit"
test-integration = "cd champollion_pipeline && pytest tests/ -v -m integration"
test-smoke = "cd champollion_pipeline && pytest tests/ -v -m smoke"
test-cov = "cd champollion_pipeline && pytest tests/ -v --cov=src --cov-report=html --cov-report=term"
test-fast = "cd champollion_pipeline && pytest tests/ -v -x --tb=short"
test-verbose = "cd champollion_pipeline && pytest tests/ -vv"
test-specific = "cd champollion_pipeline && pytest"  # Usage: pixi run test-specific tests/test_script_builder.py
